<?php

/**
 * ProjectSummaryTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ProjectSummaryTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object ProjectSummaryTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('ProjectSummary');
    }
	//set up for business sectors
	static public $business_sectors = array(
    'Agriculture' => 'Agriculture',
    'Agriprocessing' => 'Agriprocessing',
    'Tourism' => 'Tourism',
	'ICT' => 'ICT',
	'Manufacturing' => 'Manufacturing',
    'P-Education' => 'P-Education',
    'Construction' => 'Construction',
	'Real estate' => 'Real estate',
	'Mining' => 'Mining',
    'Financial services' => 'Financial services',
    'Electricity' => 'Electricity',
	'Water supply' => 'Water supply',
	'Wholesale and retail trade' => 'Wholesale and retail trade',
    'Transportation and storage' => 'Transportation and storage',
    'Professional/scientific' => 'Professional/scientific',
	'Admin/ support services' => 'Admin/ support services',
	'Public admin' => 'Public admin',
    ' Human health/social work' => 'Human health/social work',
    'Arts, entertainment and recreation' => 'Arts, entertainment and recreation',
	'Other service activities' => 'Other service activities',
	'Households as employers' => 'Households as employers',
	'Extraterritorial organizations' => 'Extraterritorial organizations',
  );
  public function getBusinessSectors()
  {
   return self::$business_sectors ;
  }
	//get Applicant details for the pdf
	public function getApplicantDetails($id)
	{
	 $query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT investment_application.name, 
	 investment_application.location, sf_guard_user.first_name,sf_guard_user.last_name  FROM investment_application
	 LEFT JOIN sf_guard_user ON investment_application.created_by = sf_guard_user.id WHERE
	 investment_application.id = '$id'"); 
	 return $query;
	}
	///method to get business details supplied with business id
	public function getBusinessInformation($business_id)
	{
	 $query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT investment_application.business_sector FROM investment_application WHERE investment_application.id = '$business_id' ");
	 
	 return $query; 
	 
	}
	//calculate local jobs total for a given business
	public function getTotalLocalJobs($business_id)
	{
	 $local_jobs_query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT sum(year1) as year1, sum(year2) as year2,sum(year3) as year3,sum(year4) as year4, sum(year5) as year5   FROM employementlocal WHERE business_plan = '$business_id' ");
	 return $local_jobs_query ;
	}
	//calculate local jobs total for a given business
	public function getTotalForeignJobs($business_id)
	{
	 $local_foreign_query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT sum(year1) as year1, sum(year2) as year2,sum(year3) as year3,sum(year4) as year4, sum(year5) as year5   FROM employementforeign WHERE business_plan = '$business_id' ");
	 return $local_foreign_query ;
	}
	//Method to calculate financial costs for a business
	public function getTotalFinancialCost($business_id)
	{
	 $costs = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT sum(year1) as year1, sum(year2) as year2, sum(year3) as year3, sum(year4) as year4, sum(year5) as year5 FROM costs WHERE id = '$business_id' ");
	 //
	 return $costs;
	}
	//Method to calculate Planned Performance costs for a business
	public function getTotalPlannedPerformance($business_id)
	{
	$performace = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT sum(year1) as year1, sum(year2) as year2, sum(year3) as year3, sum(year4) as year4, sum(year5) as year5 FROM plannedperformance WHERE id = '$business_id' ");
	 //
	 return $performace;
	}
	//Method to calculate Startup Expense costs for a business
	public function getTotalStartupExpense($business_id)
	{
	 $startup = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT sum(year1) as year1, sum(year2) as year2, sum(year3) as year3, sum(year4) as year4, sum(year5) as year5 FROM startupexpenses WHERE id = '$business_id' ");
	 //
	 return $startup;
	}
	//Method to calculate structure Financial costs for a business
	public function getTotalStructureFinancial($business_id)
	{
	 $structure = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT sum(foreign_source) as foreign_source, sum(local_source) as local_source FROM structurefinancial WHERE id = '$business_id' ");
	 //
	 return $structure;
	}
	//get a pk id using business id
	public function getSummaryId($business_id)
	{
	  $id = 0;
	  $query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT  id from project_summary where investment_id  = '$business_id' limit 1 ");
	  ///
	  foreach($query as $q)
	  {
	   $id = $q['id'];
	  }
	  //
	 // print $id; exit;
	  return $id;
	}
	//get applicant reference number when queried with business id from investmentapplication table
	public function getApplicantReferenceNumber($business_id)
	{
	  $id = 0;
	  $query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT  applicant_reference_number from investment_application where id  = '$business_id' limit 1 ");
	  ///
	  foreach($query as $q)
	  {
	   $id = $q['applicant_reference_number'];
	  }
	  //
	 // print $id; exit;
	  return $id;
	}
	//method to validate an id
	public function validateId($id)
	{
	 $query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT id from project_summary where investment_id = '$id' ");
	 return $query;
	}
	//we want to calculate all investment data from this table, that have been issued with a certificate per sector
	public function calculateInvestments()
	{
	  $query = Doctrine_Manager::getInstance()->getCurrentConnection()->fetchAssoc("SELECT business_sector, sum(planned_investment) from project_summary  left join investment_certificate ON project_summary.investment_id = investment_certificate.business_id left join  business_application_status on project_summary.investment_id = business_application_status.business_id WHERE business_application_status.application_status = 'certificateissued' group by business_sector ");
	  return $query;
	  
	}
	
}